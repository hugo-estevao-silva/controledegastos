<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Cart√£o de Cr√©dito - Vers√£o Melhorada</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .login-container h1 {
            color: #1e293b;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-name {
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-button {
            padding: 15px 30px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #3b82f6;
            background: white;
            border-bottom-color: #3b82f6;
        }

        .tab-button:hover {
            background: #f1f5f9;
            color: #3b82f6;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .form-section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9fafb;
        }

        .currency {
            color: #059669;
            font-weight: 600;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .warning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .backup-section {
            background: #fef3c7;
            border: 2px solid #f59e0b;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .backup-section h3 {
            color: #92400e;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .backup-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .storage-info {
            background: #dbeafe;
            border: 2px solid #3b82f6;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .storage-info h3 {
            color: #1e40af;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .info-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .info-item strong {
            display: block;
            color: #1e293b;
            margin-bottom: 5px;
        }

        .hidden-input {
            display: none;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                flex-direction: column;
                gap: 10px;
            }

            .backup-buttons {
                flex-direction: column;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <h1>üí≥ Controle de Gastos</h1>
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="nomeUsuario">Seu Nome</label>
            <input type="text" id="nomeUsuario" placeholder="Digite seu nome" required>
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="senhaUsuario">Senha (opcional)</label>
            <input type="password" id="senhaUsuario" placeholder="Digite uma senha (opcional)">
            <small style="color: #6b7280; margin-top: 5px;">A senha √© opcional e serve apenas para maior seguran√ßa</small>
        </div>
        <button class="btn btn-primary" onclick="fazerLogin()" style="width: 100%;">
            Entrar
        </button>
        <div id="statusLogin"></div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="mainApp" class="container" style="display: none;">
        <!-- Informa√ß√µes do usu√°rio -->
        <div class="user-info">
            <div class="user-name">Bem-vindo(a), <span id="nomeUsuarioLogado"></span>!</div>
            <button class="logout-btn" onclick="fazerLogout()">Sair</button>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('compras')">
                üìù Cadastro
            </button>
            <button class="tab-button" onclick="switchTab('visualizacao')">
                üìä Visualiza√ß√£o
            </button>
            <button class="tab-button" onclick="switchTab('backup')">
                üíæ Backup & Dados
            </button>
            <button class="tab-button" onclick="switchTab('configuracoes')">
                ‚öôÔ∏è Configura√ß√µes
            </button>
        </div>

        <!-- Aba de Cadastro -->
        <div id="compras" class="tab-content active">
            <div class="form-section">
                <h2>Nova Compra</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="cartao">Cart√£o de Cr√©dito</label>
                        <select id="cartao" required>
                            <option value="">Selecione o cart√£o</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dataCompra">Data da Compra</label>
                        <input type="date" id="dataCompra" required>
                    </div>
                    <div class="form-group">
                        <label for="descricao">Descri√ß√£o</label>
                        <input type="text" id="descricao" placeholder="Ex: Netflix, Celular" required>
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categoria</label>
                        <select id="categoria">
                            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Entretenimento">Entretenimento</option>
                            <option value="Assinaturas">Assinaturas</option>
                            <option value="Sa√∫de">Sa√∫de</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="valorTotal">Valor Total (R$)</label>
                        <input type="number" id="valorTotal" step="0.01" min="0" placeholder="0,00" required>
                    </div>
                    <div class="form-group">
                        <label for="parcelas">Parcelas</label>
                        <select id="parcelas">
                            <option value="1">1x</option>
                            <option value="2">2x</option>
                            <option value="3">3x</option>
                            <option value="4">4x</option>
                            <option value="5">5x</option>
                            <option value="6">6x</option>
                            <option value="12">12x</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="adicionarCompra()">
                    ‚ûï Adicionar Compra
                </button>
                <div id="statusCompra"></div>
            </div>

            <div class="table-container">
                <h2 style="padding: 20px; margin: 0; background: #f8fafc;">Hist√≥rico de Compras</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cart√£o</th>
                            <th>Descri√ß√£o</th>
                            <th>Categoria</th>
                            <th>Valor Total</th>
                            <th>Parcelas</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCompras">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Aba de Visualiza√ß√£o -->
        <div id="visualizacao" class="tab-content">
            <div class="form-section">
                <h2>üìä Visualiza√ß√£o de Gastos</h2>
                <p style="color: #6b7280; margin-bottom: 20px;">Visualize seus gastos mensais e por cart√£o</p>
                <div id="resumoGastos">
                    <div style="background: white; padding: 30px; border-radius: 15px; text-align: center;">
                        <h3 style="color: #3b82f6; margin-bottom: 15px;">Total de Compras</h3>
                        <div style="font-size: 48px; font-weight: bold; color: #059669;" id="totalGastos">R$ 0,00</div>
                        <div style="color: #6b7280; margin-top: 10px;" id="numeroCompras">0 compras cadastradas</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba de Backup & Dados -->
        <div id="backup" class="tab-content">
            <!-- Informa√ß√µes de Armazenamento -->
            <div class="storage-info">
                <h3>üìä Informa√ß√µes de Armazenamento</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <strong>Espa√ßo Usado</strong>
                        <span id="espacoUsado">Calculando...</span>
                    </div>
                    <div class="info-item">
                        <strong>Total de Compras</strong>
                        <span id="totalComprasInfo">0</span>
                    </div>
                    <div class="info-item">
                        <strong>Total de Cart√µes</strong>
                        <span id="totalCartoesInfo">0</span>
                    </div>
                    <div class="info-item">
                        <strong>√öltimo Backup</strong>
                        <span id="ultimoBackup">Nunca</span>
                    </div>
                </div>
            </div>

            <!-- Se√ß√£o de Backup -->
            <div class="backup-section">
                <h3>‚ö†Ô∏è Importante: Backup dos Seus Dados</h3>
                <p style="margin-bottom: 15px;">
                    <strong>Seus dados s√£o salvos apenas neste navegador!</strong> Para garantir que n√£o os perca:
                </p>
                <ul style="margin-bottom: 20px; padding-left: 20px;">
                    <li><strong>Exporte</strong> seus dados regularmente</li>
                    <li><strong>Guarde</strong> o arquivo em local seguro (Google Drive, email, etc.)</li>
                    <li><strong>Importe</strong> em caso de problemas ou ao trocar de dispositivo</li>
                </ul>
                
                <div class="backup-buttons">
                    <button class="btn btn-success" onclick="exportarDados()">
                        üì§ Exportar Dados
                    </button>
                    <button class="btn btn-primary" onclick="document.getElementById('importFile').click()">
                        üì• Importar Dados
                    </button>
                    <button class="btn btn-warning" onclick="criarBackupAutomatico()">
                        üîÑ Backup Autom√°tico
                    </button>
                    <button class="btn btn-danger" onclick="confirmarLimpezaDados()">
                        üóëÔ∏è Limpar Todos os Dados
                    </button>
                </div>
                
                <input type="file" id="importFile" class="hidden-input" accept=".json" onchange="importarDados(event)">
            </div>

            <!-- Aviso sobre Perman√™ncia -->
            <div class="form-section">
                <h2>üõ°Ô∏è Sobre a Perman√™ncia dos Dados</h2>
                <div style="background: #f0f9ff; padding: 20px; border-radius: 10px; border-left: 4px solid #3b82f6;">
                    <h4 style="color: #1e40af; margin-bottom: 10px;">‚úÖ Seus dados S√ÉO permanentes:</h4>
                    <ul style="margin-bottom: 15px;">
                        <li>Ficam salvos indefinidamente no seu navegador</li>
                        <li>N√£o expiram automaticamente</li>
                        <li>S√≥ s√£o apagados se voc√™ optar por isso</li>
                    </ul>
                    
                    <h4 style="color: #dc2626; margin-bottom: 10px;">‚ö†Ô∏è Mas podem ser perdidos se:</h4>
                    <ul style="margin-bottom: 15px;">
                        <li>Voc√™ limpar o cache/dados do navegador</li>
                        <li>Usar modo privado/inc√≥gnito</li>
                        <li>Trocar de dispositivo/navegador</li>
                        <li>Problemas t√©cnicos no navegador</li>
                    </ul>
                    
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-top: 15px;">
                        <strong>üí° Recomenda√ß√£o:</strong> Fa√ßa backup dos seus dados regularmente usando o bot√£o "Exportar Dados" acima.
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba de Configura√ß√µes -->
        <div id="configuracoes" class="tab-content">
            <div class="form-section">
                <h2>‚öôÔ∏è Configura√ß√£o de Cart√µes</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nomeCartao">Nome do Cart√£o</label>
                        <input type="text" id="nomeCartao" placeholder="Ex: Nubank Roxinho" required>
                    </div>
                    <div class="form-group">
                        <label for="limiteCartao">Limite (R$)</label>
                        <input type="number" id="limiteCartao" step="0.01" min="0" placeholder="0,00">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="adicionarCartao()">
                    ‚ûï Adicionar Cart√£o
                </button>
                <div id="statusCartao"></div>
            </div>

            <div class="table-container">
                <h2 style="padding: 20px; margin: 0; background: #f8fafc;">Meus Cart√µes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Nome do Cart√£o</th>
                            <th>Limite</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCartoes">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let usuarioAtual = null;
        let compras = [];
        let cartoes = [];

        // Sistema de persist√™ncia melhorado
        class DataManager {
            static getStorageKey(usuario, tipo) {
                return `gastos_v2_${usuario.toLowerCase().replace(/\s+/g, '_')}_${tipo}`;
            }

            static salvarDados(usuario, tipo, dados) {
                try {
                    const key = this.getStorageKey(usuario, tipo);
                    const dataToStore = {
                        data: dados,
                        timestamp: new Date().getTime(),
                        usuario: usuario,
                        versao: '2.0'
                    };
                    
                    localStorage.setItem(key, JSON.stringify(dataToStore));
                    
                    // Salvar timestamp do √∫ltimo save
                    localStorage.setItem(`${key}_lastSave`, new Date().toISOString());
                    
                    console.log(`‚úÖ Dados salvos: ${key}`, dados);
                    return true;
                } catch (error) {
                    console.error('‚ùå Erro ao salvar dados:', error);
                    
                    if (error.name === 'QuotaExceededError') {
                        mostrarStatus('statusCompra', '‚ùå Espa√ßo de armazenamento esgotado! Fa√ßa backup e limpe dados antigos.', 'error');
                    }
                    return false;
                }
            }

            static carregarDados(usuario, tipo) {
                try {
                    const key = this.getStorageKey(usuario, tipo);
                    const dados = localStorage.getItem(key);
                    
                    if (dados) {
                        const parsed = JSON.parse(dados);
                        console.log(`üìÅ Dados carregados: ${key}`);
                        return parsed.data || parsed;
                    }
                    return [];
                } catch (error) {
                    console.error('‚ùå Erro ao carregar dados:', error);
                    return [];
                }
            }

            static verificarUsuario(nome, senha = '') {
                try {
                    const usuarios = JSON.parse(localStorage.getItem('usuarios_v2') || '{}');
                    const usuarioKey = nome.toLowerCase().replace(/\s+/g, '_');
                    
                    if (usuarios[usuarioKey]) {
                        if (usuarios[usuarioKey].senha && usuarios[usuarioKey].senha !== senha) {
                            return { sucesso: false, mensagem: 'Senha incorreta!' };
                        }
                        
                        // Atualizar √∫ltimo login
                        usuarios[usuarioKey].ultimoLogin = new Date().toISOString();
                        localStorage.setItem('usuarios_v2', JSON.stringify(usuarios));
                        
                        return { sucesso: true, usuario: usuarios[usuarioKey] };
                    } else {
                        // Novo usu√°rio
                        const novoUsuario = {
                            nome,
                            senha,
                            dataCriacao: new Date().toISOString(),
                            ultimoLogin: new Date().toISOString()
                        };
                        
                        usuarios[usuarioKey] = novoUsuario;
                        localStorage.setItem('usuarios_v2', JSON.stringify(usuarios));
                        
                        return { sucesso: true, usuario: novoUsuario, novo: true };
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao verificar usu√°rio:', error);
                    return { sucesso: false, mensagem: 'Erro interno.' };
                }
            }

            static obterEstatisticas(usuario) {
                try {
                    let totalSize = 0;
                    let itensEncontrados = 0;
                    
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key) && key.includes(usuario.toLowerCase().replace(/\s+/g, '_'))) {
                            const itemSize = localStorage.getItem(key).length;
                            totalSize += itemSize;
                            itensEncontrados++;
                        }
                    }
                    
                    return {
                        tamanhoKB: Math.round(totalSize / 1024),
                        itens: itensEncontrados,
                        ultimoBackup: this.obterUltimoBackup(usuario)
                    };
                } catch (error) {
                    return { tamanhoKB: 0, itens: 0, ultimoBackup: null };
                }
            }

            static obterUltimoBackup(usuario) {
                try {
                    const backupKey = `backup_${usuario.toLowerCase().replace(/\s+/g, '_')}_timestamp`;
                    const timestamp = localStorage.getItem(backupKey);
                    return timestamp ? new Date(timestamp) : null;
                } catch (error) {
                    return null;
                }
            }

            static salvarBackup(usuario) {
                try {
                    const dados = {
                        usuario,
                        dataBackup: new Date().toISOString(),
                        compras: this.carregarDados(usuario, 'compras'),
                        cartoes: this.carregarDados(usuario, 'cartoes'),
                        versao: '2.0'
                    };

                    const backupKey = `backup_${usuario.toLowerCase().replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}`;
                    const timestampKey = `backup_${usuario.toLowerCase().replace(/\s+/g, '_')}_timestamp`;
                    
                    localStorage.setItem(backupKey, JSON.stringify(dados));
                    localStorage.setItem(timestampKey, new Date().toISOString());
                    
                    // Limitar a 5 backups por usu√°rio
                    this.limparBackupsAntigos(usuario);
                    
                    return dados;
                } catch (error) {
                    console.error('‚ùå Erro ao criar backup:', error);
                    return null;
                }
            }

            static limparBackupsAntigos(usuario) {
                try {
                    const prefixo = `backup_${usuario.toLowerCase().replace(/\s+/g, '_')}_`;
                    const chaves = [];
                    
                    for (let key in localStorage) {
                        if (key.startsWith(prefixo) && key.includes('-')) { // backups t√™m data
                            chaves.push(key);
                        }
                    }
                    
                    if (chaves.length > 5) {
                        chaves.sort().slice(0, -5).forEach(key => {
                            localStorage.removeItem(key);
                        });
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao limpar backups:', error);
                }
            }
        }

        // Fun√ß√µes de autentica√ß√£o
        function fazerLogin() {
            const nome = document.getElementById('nomeUsuario').value.trim();
            const senha = document.getElementById('senhaUsuario').value;

            if (!nome) {
                mostrarStatus('statusLogin', 'Digite seu nome!', 'error');
                return;
            }

            const resultado = DataManager.verificarUsuario(nome, senha);
            
            if (resultado.sucesso) {
                usuarioAtual = resultado.usuario;
                document.getElementById('nomeUsuarioLogado').textContent = usuarioAtual.nome;
                
                carregarDadosUsuario();
                
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                const mensagem = resultado.novo ? 
                    'üéâ Bem-vindo! Conta criada com sucesso!' : 
                    '‚úÖ Login realizado!';
                    
                setTimeout(() => mostrarStatus('statusCompra', mensagem, 'success'), 500);
            } else {
                mostrarStatus('statusLogin', resultado.mensagem, 'error');
            }
        }

        function fazerLogout() {
            if (confirm('Deseja sair? Seus dados ficar√£o salvos.')) {
                usuarioAtual = null;
                compras = [];
                cartoes = [];
                
                document.getElementById('nomeUsuario').value = '';
                document.getElementById('senhaUsuario').value = '';
                
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
            }
        }

        function carregarDadosUsuario() {
            if (!usuarioAtual) return;
            
            compras = DataManager.carregarDados(usuarioAtual.nome, 'compras') || [];
            cartoes = DataManager.carregarDados(usuarioAtual.nome, 'cartoes') || [];
            
            // Cart√µes padr√£o para novos usu√°rios
            if (cartoes.length === 0) {
                cartoes = [
                    { id: 1, nome: "Nubank", limite: 0 },
                    { id: 2, nome: "Inter", limite: 0 },
                    { id: 3, nome: "C6 Bank", limite: 0 }
                ];
                DataManager.salvarDados(usuarioAtual.nome, 'cartoes', cartoes);
            }
            
            atualizarInterface();
        }

        function salvarDadosUsuario() {
            if (usuarioAtual) {
                const sucessoCompras = DataManager.salvarDados(usuarioAtual.nome, 'compras', compras);
                const sucessoCartoes = DataManager.salvarDados(usuarioAtual.nome, 'cartoes', cartoes);
                return sucessoCompras && sucessoCartoes;
            }
            return false;
        }

        // Fun√ß√µes da interface
        function mostrarStatus(elementId, mensagem, tipo) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status-message ${tipo}">${mensagem}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, tipo === 'error' ? 5000 : 3000);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
            
            if (tabName === 'backup') {
                atualizarInfoStorage();
            }
            
            if (tabName === 'visualizacao') {
                atualizarVisualizacao();
            }
        }

        function atualizarInterface() {
            document.getElementById('dataCompra').value = new Date().toISOString().split('T')[0];
            carregarCartoes();
            atualizarTabelaCartoes();
            atualizarTabelaCompras();
            atualizarVisualizacao();
        }

        // Fun√ß√µes de cart√µes
        function adicionarCartao() {
            const nome = document.getElementById('nomeCartao').value.trim();
            const limite = parseFloat(document.getElementById('limiteCartao').value) || 0;

            if (!nome) {
                mostrarStatus('statusCartao', 'Digite o nome do cart√£o!', 'error');
                return;
            }

            if (cartoes.find(c => c.nome.toLowerCase() === nome.toLowerCase())) {
                mostrarStatus('statusCartao', 'Cart√£o j√° existe!', 'error');
                return;
            }

            const cartao = {
                id: Date.now(),
                nome,
                limite
            };

            cartoes.push(cartao);
            
            if (salvarDadosUsuario()) {
                atualizarTabelaCartoes();
                carregarCartoes();
                limparFormularioCartao();
                mostrarStatus('statusCartao', '‚úÖ Cart√£o adicionado!', 'success');
            } else {
                cartoes.pop();
                mostrarStatus('statusCartao', '‚ùå Erro ao salvar!', 'error');
            }
        }

        function excluirCartao(id) {
            const cartao = cartoes.find(c => c.id === id);
            if (!cartao) return;

            const comprasVinculadas = compras.filter(c => c.cartao === cartao.nome);
            
            let mensagem = `Excluir "${cartao.nome}"?`;
            if (comprasVinculadas.length > 0) {
                mensagem += `\n\n‚ö†Ô∏è ${comprasVinculadas.length} compra(s) vinculada(s).`;
            }

            if (confirm(mensagem)) {
                cartoes = cartoes.filter(c => c.id !== id);
                
                if (salvarDadosUsuario()) {
                    atualizarTabelaCartoes();
                    carregarCartoes();
                    mostrarStatus('statusCartao', '‚úÖ Cart√£o exclu√≠do!', 'success');
                } else {
                    cartoes.push(cartao);
                    mostrarStatus('statusCartao', '‚ùå Erro ao salvar!', 'error');
                }
            }
        }

        function atualizarTabelaCartoes() {
            const tbody = document.getElementById('tabelaCartoes');
            tbody.innerHTML = '';

            if (cartoes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b7280; padding: 30px;">Nenhum cart√£o cadastrado</td></tr>';
                return;
            }

            cartoes.forEach(cartao => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${cartao.nome}</td>
                    <td class="currency">${cartao.limite > 0 ? `R$ ${cartao.limite.toFixed(2).replace('.', ',')}` : 'N√£o informado'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="excluirCartao(${cartao.id})" title="Excluir">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
            });
        }

        function carregarCartoes() {
            const select = document.getElementById('cartao');
            select.innerHTML = '<option value="">Selecione o cart√£o</option>';

            cartoes.forEach(cartao => {
                const option = document.createElement('option');
                option.value = cartao.nome;
                option.textContent = cartao.nome;
                select.appendChild(option);
            });
        }

        function limparFormularioCartao() {
            document.getElementById('nomeCartao').value = '';
            document.getElementById('limiteCartao').value = '';
        }

        // Fun√ß√µes de compras
        function adicionarCompra() {
            const cartao = document.getElementById('cartao').value;
            const dataCompra = document.getElementById('dataCompra').value;
            const descricao = document.getElementById('descricao').value.trim();
            const categoria = document.getElementById('categoria').value;
            const valorTotal = parseFloat(document.getElementById('valorTotal').value);
            const parcelas = parseInt(document.getElementById('parcelas').value);

            if (!cartao || !dataCompra || !descricao || !valorTotal || !parcelas) {
                mostrarStatus('statusCompra', 'Preencha todos os campos!', 'error');
                return;
            }

            if (valorTotal <= 0 || parcelas <= 0) {
                mostrarStatus('statusCompra', 'Valores devem ser positivos!', 'error');
                return;
            }

            const compra = {
                id: Date.now(),
                cartao,
                dataCompra,
                descricao,
                categoria,
                valorTotal,
                parcelas,
                valorParcela: valorTotal / parcelas
            };

            compras.push(compra);
            
            if (salvarDadosUsuario()) {
                atualizarTabelaCompras();
                limparFormulario();
                atualizarVisualizacao();
                mostrarStatus('statusCompra', '‚úÖ Compra adicionada!', 'success');
            } else {
                compras.pop();
                mostrarStatus('statusCompra', '‚ùå Erro ao salvar!', 'error');
            }
        }

        function excluirCompra(id) {
            const compra = compras.find(c => c.id === id);
            if (!compra) return;

            if (confirm(`Excluir "${compra.descricao}"?`)) {
                compras = compras.filter(c => c.id !== id);
                
                if (salvarDadosUsuario()) {
                    atualizarTabelaCompras();
                    atualizarVisualizacao();
                    mostrarStatus('statusCompra', '‚úÖ Compra exclu√≠da!', 'success');
                } else {
                    compras.push(compra);
                    mostrarStatus('statusCompra', '‚ùå Erro ao salvar!', 'error');
                }
            }
        }

        function atualizarTabelaCompras() {
            const tbody = document.getElementById('tabelaCompras');
            tbody.innerHTML = '';

            if (compras.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #6b7280; padding: 30px;">Nenhuma compra cadastrada</td></tr>';
                return;
            }

            const comprasOrdenadas = [...compras].sort((a, b) => new Date(b.dataCompra) - new Date(a.dataCompra));

            comprasOrdenadas.forEach(compra => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${new Date(compra.dataCompra + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${compra.cartao}</td>
                    <td>${compra.descricao}</td>
                    <td>${compra.categoria}</td>
                    <td class="currency">R$ ${compra.valorTotal.toFixed(2).replace('.', ',')}</td>
                    <td>${compra.parcelas}x</td>
                    <td>
                        <button class="btn btn-danger" onclick="excluirCompra(${compra.id})" title="Excluir">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
            });
        }

        function limparFormulario() {
            document.getElementById('cartao').value = '';
            document.getElementById('descricao').value = '';
            document.getElementById('categoria').value = 'Alimenta√ß√£o';
            document.getElementById('valorTotal').value = '';
            document.getElementById('parcelas').value = '1';
        }

        function atualizarVisualizacao() {
            const total = compras.reduce((sum, compra) => sum + compra.valorTotal, 0);
            const numeroCompras = compras.length;
            
            document.getElementById('totalGastos').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            document.getElementById('numeroCompras').textContent = `${numeroCompras} compra${numeroCompras !== 1 ? 's' : ''} cadastrada${numeroCompras !== 1 ? 's' : ''}`;
        }

        // Fun√ß√µes de backup
        function atualizarInfoStorage() {
            if (!usuarioAtual) return;
            
            const stats = DataManager.obterEstatisticas(usuarioAtual.nome);
            
            document.getElementById('espacoUsado').textContent = `${stats.tamanhoKB} KB`;
            document.getElementById('totalComprasInfo').textContent = compras.length;
            document.getElementById('totalCartoesInfo').textContent = cartoes.length;
            
            if (stats.ultimoBackup) {
                const data = stats.ultimoBackup.toLocaleDateString('pt-BR');
                const hora = stats.ultimoBackup.toLocaleTimeString('pt-BR');
                document.getElementById('ultimoBackup').textContent = `${data} √†s ${hora}`;
            } else {
                document.getElementById('ultimoBackup').textContent = 'Nunca';
            }
        }

        function exportarDados() {
            if (!usuarioAtual) {
                mostrarStatus('statusCompra', '‚ùå Usu√°rio n√£o logado!', 'error');
                return;
            }

            try {
                const dados = {
                    usuario: usuarioAtual.nome,
                    dataExportacao: new Date().toISOString(),
                    versao: '2.0',
                    compras: compras,
                    cartoes: cartoes,
                    estatisticas: {
                        totalCompras: compras.length,
                        totalCartoes: cartoes.length,
                        valorTotal: compras.reduce((sum, c) => sum + c.valorTotal, 0)
                    }
                };

                const dataStr = JSON.stringify(dados, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `gastos_${usuarioAtual.nome.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                URL.revokeObjectURL(url);
                mostrarStatus('statusCompra', '‚úÖ Dados exportados com sucesso!', 'success');
                
                console.log('üì§ Dados exportados:', dados);
            } catch (error) {
                console.error('‚ùå Erro ao exportar:', error);
                mostrarStatus('statusCompra', '‚ùå Erro ao exportar dados!', 'error');
            }
        }

        function importarDados(event) {
            if (!usuarioAtual) {
                mostrarStatus('statusCompra', '‚ùå Usu√°rio n√£o logado!', 'error');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dadosImportados = JSON.parse(e.target.result);
                    
                    if (!dadosImportados.compras && !dadosImportados.cartoes) {
                        mostrarStatus('statusCompra', '‚ùå Arquivo inv√°lido!', 'error');
                        return;
                    }

                    const confirmacao = confirm(`
Importar dados de "${dadosImportados.usuario || 'Usu√°rio desconhecido'}"?

üìä Compras: ${dadosImportados.compras?.length || 0}
üí≥ Cart√µes: ${dadosImportados.cartoes?.length || 0}

‚ö†Ô∏è ATEN√á√ÉO: Isso substituir√° todos os seus dados atuais!
                    `.trim());

                    if (confirmacao) {
                        if (dadosImportados.compras) {
                            compras = dadosImportados.compras;
                        }
                        if (dadosImportados.cartoes) {
                            cartoes = dadosImportados.cartoes;
                        }

                        if (salvarDadosUsuario()) {
                            atualizarInterface();
                            mostrarStatus('statusCompra', '‚úÖ Dados importados com sucesso!', 'success');
                        } else {
                            mostrarStatus('statusCompra', '‚ùå Erro ao salvar dados importados!', 'error');
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao importar:', error);
                    mostrarStatus('statusCompra', '‚ùå Arquivo inv√°lido ou corrompido!', 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = '';
        }

        function criarBackupAutomatico() {
            if (!usuarioAtual) {
                mostrarStatus('statusCompra', '‚ùå Usu√°rio n√£o logado!', 'error');
                return;
            }

            const backup = DataManager.salvarBackup(usuarioAtual.nome);
            
            if (backup) {
                atualizarInfoStorage();
                mostrarStatus('statusCompra', '‚úÖ Backup autom√°tico criado!', 'success');
                console.log('üíæ Backup criado:', backup);
            } else {
                mostrarStatus('statusCompra', '‚ùå Erro ao criar backup!', 'error');
            }
        }

        function confirmarLimpezaDados() {
            if (!usuarioAtual) {
                mostrarStatus('statusCompra', '‚ùå Usu√°rio n√£o logado!', 'error');
                return;
            }

            const confirmacao = confirm(`
‚ö†Ô∏è CUIDADO! A√á√ÉO IRREVERS√çVEL! ‚ö†Ô∏è

Voc√™ est√° prestes a APAGAR TODOS os dados:
‚Ä¢ ${compras.length} compras
‚Ä¢ ${cartoes.length} cart√µes
‚Ä¢ Todos os backups

Esta a√ß√£o N√ÉO pode ser desfeita!

Tem certeza absoluta?
            `.trim());

            if (confirmacao) {
                const segundaConfirmacao = confirm('√öLTIMA CHANCE!\n\nDigite OK se tem certeza que quer apagar TUDO:');
                
                if (segundaConfirmacao) {
                    try {
                        // Limpar dados do usu√°rio
                        for (let key in localStorage) {
                            if (key.includes(usuarioAtual.nome.toLowerCase().replace(/\s+/g, '_'))) {
                                localStorage.removeItem(key);
                            }
                        }
                        
                        // Resetar arrays
                        compras = [];
                        cartoes = [];
                        
                        atualizarInterface();
                        mostrarStatus('statusCompra', 'üóëÔ∏è Todos os dados foram apagados!', 'warning');
                        
                        console.log('üóëÔ∏è Dados limpos para:', usuarioAtual.nome);
                    } catch (error) {
                        console.error('‚ùå Erro ao limpar dados:', error);
                        mostrarStatus('statusCompra', '‚ùå Erro ao limpar dados!', 'error');
                    }
                }
            }
        }

        // Salvamento autom√°tico
        function salvarAutomatico() {
            if (usuarioAtual && (compras.length > 0 || cartoes.length > 0)) {
                salvarDadosUsuario();
                console.log('üíæ Salvamento autom√°tico executado');
            }
        }

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Sistema de Controle de Gastos v2.0 iniciado');
            
            // Verificar localStorage
            if (typeof(Storage) === "undefined") {
                alert('‚ö†Ô∏è Seu navegador n√£o suporta armazenamento local. Os dados n√£o ser√£o salvos!');
            }
            
            // Tentar carregar √∫ltimo usu√°rio
            try {
                const ultimoUsuario = localStorage.getItem('ultimo_usuario_v2');
                if (ultimoUsuario) {
                    document.getElementById('nomeUsuario').value = ultimoUsuario;
                }
            } catch (error) {
                console.warn('Erro ao carregar √∫ltimo usu√°rio:', error);
            }
        });

        // Salvar automaticamente a cada 30 segundos
        setInterval(salvarAutomatico, 30000);

        // Salvar antes de fechar
        window.addEventListener('beforeunload', function() {
            if (usuarioAtual) {
                salvarDadosUsuario();
                try {
                    localStorage.setItem('ultimo_usuario_v2', usuarioAtual.nome);
                } catch (error) {
                    console.error('Erro ao salvar √∫ltimo usu√°rio:', error);
                }
            }
        });

        // Atalhos de teclado
        document.addEventListener('keydown', function(e) {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (usuarioAtual) {
                    exportarDados();
                }
            }
            
            if (document.getElementById('loginScreen').style.display !== 'none' && e.key === 'Enter') {
                fazerLogin();
            }
        });

        console.log('‚úÖ Sistema carregado e pronto para uso!');
    </script>
</body>
</html>
