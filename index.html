<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle de Cart√£o de Cr√©dito</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .login-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
        }

        .login-container h1 {
            color: #1e293b;
            margin-bottom: 30px;
            font-size: 28px;
        }

        .user-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .user-name {
            font-weight: 600;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 15px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 12px;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .tab-button {
            padding: 15px 30px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #64748b;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-button.active {
            color: #3b82f6;
            background: white;
            border-bottom-color: #3b82f6;
        }

        .tab-button:hover {
            background: #f1f5f9;
            color: #3b82f6;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .form-section {
            background: #f8fafc;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        .form-section h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .table-container {
            overflow-x: auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
        }

        th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            position: sticky;
            top: 0;
        }

        tr:hover {
            background: #f9fafb;
        }

        .currency {
            color: #059669;
            font-weight: 600;
        }

        .presentation-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .presentation-section h2 {
            margin-bottom: 20px;
            font-size: 28px;
            text-align: center;
        }

        .filters {
            display: flex;
            gap: 20px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .filter-group select {
            background: white;
            min-width: 200px;
        }

        .summary-card {
            background: white;
            color: #1e293b;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            text-align: center;
        }

        .summary-total {
            font-size: 48px;
            font-weight: bold;
            color: #3b82f6;
            margin: 20px 0;
        }

        .details-list {
            background: #f8fafc;
            padding: 25px;
            border-radius: 15px;
            margin-top: 30px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .detail-item:last-child {
            border-bottom: none;
        }

        .detail-description {
            flex: 1;
            font-weight: 500;
        }

        .detail-value {
            font-weight: bold;
            color: #059669;
            font-size: 18px;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #6b7280;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 20px;
            color: #d1d5db;
        }

        .status-message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            text-align: center;
        }

        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Estilos para relat√≥rios */
        .report-filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .report-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .report-card h3 {
            color: #1e293b;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .report-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .report-item:last-child {
            border-bottom: none;
        }

        .report-label {
            font-weight: 500;
            color: #374151;
        }

        .report-value {
            font-weight: bold;
            color: #059669;
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .filters {
                flex-direction: column;
                align-items: center;
            }
            
            .summary-total {
                font-size: 36px;
            }

            .user-info {
                flex-direction: column;
                gap: 10px;
            }

            .report-filters {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Tela de Login -->
    <div id="loginScreen" class="login-container">
        <h1>üí≥ Controle de Gastos</h1>
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="nomeUsuario">Seu Nome</label>
            <input type="text" id="nomeUsuario" placeholder="Digite seu nome" required>
        </div>
        <div class="form-group" style="margin-bottom: 20px;">
            <label for="senhaUsuario">Senha (opcional)</label>
            <input type="password" id="senhaUsuario" placeholder="Digite uma senha (opcional)">
            <small style="color: #6b7280; margin-top: 5px;">A senha √© opcional e serve apenas para maior seguran√ßa</small>
        </div>
        <button class="btn btn-primary" onclick="fazerLogin()" style="width: 100%;">
            Entrar
        </button>
        <div id="statusLogin"></div>
    </div>

    <!-- Aplica√ß√£o Principal -->
    <div id="mainApp" class="container" style="display: none;">
        <!-- Informa√ß√µes do usu√°rio -->
        <div class="user-info">
            <div class="user-name">Bem-vindo(a), <span id="nomeUsuarioLogado"></span>!</div>
            <button class="logout-btn" onclick="fazerLogout()">Sair</button>
        </div>

        <div class="tabs">
            <button class="tab-button active" onclick="switchTab('compras')">
                üìù Cadastro de Compras
            </button>
            <button class="tab-button" onclick="switchTab('apresentacao')">
                üìä Visualiza√ß√£o
            </button>
            <button class="tab-button" onclick="switchTab('relatorios')">
                üìã Relat√≥rios
            </button>
            <button class="tab-button" onclick="switchTab('configuracoes')">
                ‚öôÔ∏è Configura√ß√µes
            </button>
        </div>

        <!-- Aba de Cadastro de Compras -->
        <div id="compras" class="tab-content active">
            <div class="form-section">
                <h2>Nova Compra</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="tipoCompra">Tipo de Compra</label>
                        <select id="tipoCompra" onchange="toggleFinanciamento()">
                            <option value="normal">üí≥ Compra no Cart√£o</option>
                            <option value="financiamento">üí∞ Financiamento</option>
                        </select>
                    </div>
                    <div class="form-group" id="grupoCartao">
                        <label for="cartao">Cart√£o de Cr√©dito</label>
                        <select id="cartao" required>
                            <option value="">Selecione o cart√£o</option>
                            <!-- Cart√µes ser√£o carregados dinamicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="dataCompra">Data da Compra/Contrata√ß√£o</label>
                        <input type="date" id="dataCompra" required>
                    </div>
                    <div class="form-group">
                        <label for="descricao" id="labelDescricao">Descri√ß√£o da Compra</label>
                        <input type="text" id="descricao" placeholder="Ex: Netflix, Celular, Supermercado" required>
                    </div>
                    <div class="form-group">
                        <label for="categoria">Categoria</label>
                        <select id="categoria">
                            <option value="">Selecione uma categoria</option>
                            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Entretenimento">Entretenimento</option>
                            <option value="Assinaturas">Assinaturas</option>
                            <option value="Sa√∫de">Sa√∫de</option>
                            <option value="Educa√ß√£o">Educa√ß√£o</option>
                            <option value="Roupas">Roupas</option>
                            <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                            <option value="Casa">Casa</option>
                            <option value="Financiamento">üí∞ Financiamento</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="valorTotal" id="labelValorTotal">Valor Total (R$)</label>
                        <input type="number" id="valorTotal" step="0.01" min="0" placeholder="0,00" required>
                    </div>
                    <div class="form-group">
                        <label for="parcelas">Quantidade de Parcelas</label>
                        <select id="parcelas" required>
                            <!-- Op√ß√µes ser√£o carregadas dinamicamente -->
                        </select>
                    </div>
                </div>
                
                <!-- Se√ß√£o de Financiamento (oculta por padr√£o) -->
                <div id="secaoFinanciamento" style="display: none;">
                    <h3 style="color: #1e293b; margin-bottom: 15px;">üí∞ Detalhes do Financiamento</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="valorFinanciado">Valor Financiado (R$)</label>
                            <input type="number" id="valorFinanciado" step="0.01" min="0" placeholder="Valor sem entrada">
                        </div>
                        <div class="form-group">
                            <label for="taxaJuros">Taxa de Juros (% a.m.)</label>
                            <input type="number" id="taxaJuros" step="0.01" min="0" placeholder="Ex: 2.5">
                        </div>
                        <div class="form-group">
                            <label for="tipoFinanciamento">Tipo de Financiamento</label>
                            <select id="tipoFinanciamento">
                                <option value="">Selecione o tipo</option>
                                <option value="Ve√≠culo">Ve√≠culo</option>
                                <option value="Im√≥vel">Im√≥vel</option>
                                <option value="Reforma">Reforma</option>
                                <option value="Educa√ß√£o">Educa√ß√£o</option>
                                <option value="Consolida√ß√£o">Consolida√ß√£o de D√≠vidas</option>
                                <option value="Outros">Outros</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="entrada">Valor da Entrada (R$)</label>
                            <input type="number" id="entrada" step="0.01" min="0" placeholder="0,00">
                        </div>
                        <div class="form-group">
                            <label for="primeiraParcela">Data da Primeira Parcela</label>
                            <input type="date" id="primeiraParcela" required>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="observacoes">Observa√ß√µes (opcional)</label>
                    <textarea id="observacoes" rows="3" placeholder="Informa√ß√µes adicionais sobre a compra/financiamento"></textarea>
                </div>
                <button class="btn btn-primary" onclick="adicionarCompra()">
                    ‚ûï Adicionar Compra
                </button>
                <div id="statusCompra"></div>
            </div>

            <div class="table-container">
                <h2 style="padding: 20px; margin: 0; background: #f8fafc;">Hist√≥rico de Compras</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cart√£o</th>
                            <th>Descri√ß√£o</th>
                            <th>Categoria</th>
                            <th>Valor Total</th>
                            <th>Parcelas</th>
                            <th>Valor/Parcela</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCompras">
                        <!-- Compras ser√£o inseridas aqui -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Aba de Apresenta√ß√£o -->
        <div id="apresentacao" class="tab-content">
            <div class="presentation-section">
                <h2>üí≥ Visualiza√ß√£o de Gastos</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filtroCartao">Cart√£o</label>
                        <select id="filtroCartao" onchange="atualizarVisualizacao()">
                            <option value="">Todos os cart√µes</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filtroMes">M√™s</label>
                        <select id="filtroMes" onchange="atualizarVisualizacao()">
                            <!-- Meses ser√£o preenchidos dinamicamente -->
                        </select>
                    </div>
                </div>
                
                <div class="summary-card">
                    <h3>Total a Pagar</h3>
                    <div class="summary-total" id="totalPagar">R$ 0,00</div>
                    <p id="periodoInfo">Selecione um per√≠odo para visualizar</p>
                </div>
            </div>

            <div class="details-list">
                <h3 style="margin-bottom: 20px; color: #1e293b;">Detalhamento dos Gastos</h3>
                <div id="detalhesGastos">
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìä</div>
                        <p>Selecione um cart√£o e m√™s para ver os detalhes dos gastos</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba de Relat√≥rios -->
        <div id="relatorios" class="tab-content">
            <div class="form-section">
                <h2>üìã Relat√≥rios</h2>
                <div class="report-filters">
                    <div class="form-group">
                        <label for="relatorioDataInicio">Data In√≠cio</label>
                        <input type="date" id="relatorioDataInicio" onchange="gerarRelatorio()">
                    </div>
                    <div class="form-group">
                        <label for="relatorioDataFim">Data Fim</label>
                        <input type="date" id="relatorioDataFim" onchange="gerarRelatorio()">
                    </div>
                    <div class="form-group">
                        <label for="relatorioCartao">Cart√£o</label>
                        <select id="relatorioCartao" onchange="gerarRelatorio()">
                            <option value="">Todos os cart√µes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="relatorioCategoria">Categoria</label>
                        <select id="relatorioCategoria" onchange="gerarRelatorio()">
                            <option value="">Todas as categorias</option>
                            <option value="Alimenta√ß√£o">Alimenta√ß√£o</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Entretenimento">Entretenimento</option>
                            <option value="Assinaturas">Assinaturas</option>
                            <option value="Sa√∫de">Sa√∫de</option>
                            <option value="Educa√ß√£o">Educa√ß√£o</option>
                            <option value="Roupas">Roupas</option>
                            <option value="Eletr√¥nicos">Eletr√¥nicos</option>
                            <option value="Casa">Casa</option>
                            <option value="Financiamento">üí∞ Financiamento</option>
                            <option value="Outros">Outros</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Relat√≥rio por Cart√£o -->
            <div class="report-card">
                <h3>üí≥ Gastos por Cart√£o</h3>
                <div id="relatorioCartoes">
                    <div class="empty-state">
                        <p>Configure os filtros acima para gerar o relat√≥rio</p>
                    </div>
                </div>
            </div>

            <!-- Relat√≥rio por Categoria -->
            <div class="report-card">
                <h3>üè∑Ô∏è Gastos por Categoria</h3>
                <div id="relatorioCategorias">
                    <div class="empty-state">
                        <p>Configure os filtros acima para gerar o relat√≥rio</p>
                    </div>
                </div>
            </div>

            <!-- Relat√≥rio Mensal -->
            <div class="report-card">
                <h3>üìÖ Gastos Mensais</h3>
                <div id="relatorioMensal">
                    <div class="empty-state">
                        <p>Configure os filtros acima para gerar o relat√≥rio</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba de Configura√ß√µes -->
        <div id="configuracoes" class="tab-content">
            <div class="form-section">
                <h2>‚öôÔ∏è Configura√ß√£o de Cart√µes</h2>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="nomeCartao">Nome do Cart√£o</label>
                        <input type="text" id="nomeCartao" placeholder="Ex: Nubank Roxinho" required>
                    </div>
                    <div class="form-group">
                        <label for="diaFechamento">Dia de Fechamento</label>
                        <select id="diaFechamento" required>
                            <option value="">Selecione o dia</option>
                            <option value="1">Dia 1</option>
                            <option value="5">Dia 5</option>
                            <option value="10">Dia 10</option>
                            <option value="15">Dia 15</option>
                            <option value="20">Dia 20</option>
                            <option value="25">Dia 25</option>
                            <option value="30">Dia 30</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="diaVencimento">Dia de Vencimento</label>
                        <select id="diaVencimento" required>
                            <option value="">Selecione o dia</option>
                            <option value="5">Dia 5</option>
                            <option value="10">Dia 10</option>
                            <option value="15">Dia 15</option>
                            <option value="20">Dia 20</option>
                            <option value="25">Dia 25</option>
                            <option value="30">Dia 30</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="limiteCartao">Limite (R$) - Opcional</label>
                        <input type="number" id="limiteCartao" step="0.01" min="0" placeholder="0,00">
                    </div>
                </div>
                <div class="form-group">
                    <label for="observacoesCartao">Observa√ß√µes do Cart√£o (opcional)</label>
                    <textarea id="observacoesCartao" rows="2" placeholder="Informa√ß√µes adicionais sobre o cart√£o"></textarea>
                </div>
                <button class="btn btn-primary" onclick="adicionarCartao()">
                    ‚ûï Adicionar Cart√£o
                </button>
                <div id="statusCartao"></div>
            </div>

            <div class="table-container">
                <h2 style="padding: 20px; margin: 0; background: #f8fafc;">Meus Cart√µes</h2>
                <table>
                    <thead>
                        <tr>
                            <th>Nome do Cart√£o</th>
                            <th>Fechamento</th>
                            <th>Vencimento</th>
                            <th>Limite</th>
                            <th>Observa√ß√µes</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaCartoes">
                        <!-- Cart√µes ser√£o inseridos aqui -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Vari√°veis globais
        let usuarioAtual = null;
        let compras = [];
        let cartoes = [];

        // Sistema de persist√™ncia de dados usando localStorage
        class DataManager {
            static getStorageKey(usuario, tipo) {
                return `gastos_${usuario.toLowerCase().replace(/\s+/g, '_')}_${tipo}`;
            }

            static salvarDados(usuario, tipo, dados) {
                try {
                    const key = this.getStorageKey(usuario, tipo);
                    const dataToStore = { 
                        data: dados, 
                        timestamp: new Date().getTime(),
                        usuario: usuario,
                        versao: '1.0' // Para futuras migra√ß√µes
                    };
                    const dataString = JSON.stringify(dataToStore);
                    localStorage.setItem(key, dataString);
                    
                    // Log para debug
                    console.log(`Dados salvos: ${key}`, dados);
                    return true;
                } catch (error) {
                    console.error('Erro ao salvar dados:', error);
                    
                    // Verificar se o erro √© por falta de espa√ßo
                    if (error.name === 'QuotaExceededError' || error.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                        mostrarStatus('statusCompra', 'Erro: Espa√ßo de armazenamento local esgotado! Considere exportar seus dados.', 'error');
                    } else {
                        mostrarStatus('statusCompra', 'Erro ao salvar dados localmente.', 'error');
                    }
                    return false;
                }
            }

            static carregarDados(usuario, tipo) {
                try {
                    const key = this.getStorageKey(usuario, tipo);
                    const dados = localStorage.getItem(key);
                    
                    if (dados) {
                        const parsed = JSON.parse(dados);
                        
                        // Log para debug
                        console.log(`Dados carregados: ${key}`, parsed.data || parsed);
                        
                        return parsed.data || parsed; // Compatibilidade com formato anterior
                    }
                    return null;
                } catch (error) {
                    console.error('Erro ao carregar dados:', error);
                    mostrarStatus('statusCompra', 'Erro ao carregar dados locais.', 'error');
                    return null;
                }
            }

            static verificarUsuario(nome, senha = '') {
                try {
                    const usuarios = JSON.parse(localStorage.getItem('usuarios_cadastrados') || '{}');
                    const usuarioKey = nome.toLowerCase().replace(/\s+/g, '_');
                    
                    if (usuarios[usuarioKey]) {
                        // Usu√°rio existe, verificar senha se foi definida
                        if (usuarios[usuarioKey].senha && usuarios[usuarioKey].senha !== senha) {
                            return { sucesso: false, mensagem: 'Senha incorreta!' };
                        }
                        return { sucesso: true, usuario: usuarios[usuarioKey] };
                    } else {
                        // Novo usu√°rio
                        const novoUsuario = { 
                            nome, 
                            senha, 
                            dataCriacao: new Date().toISOString(),
                            ultimoLogin: new Date().toISOString()
                        };
                        usuarios[usuarioKey] = novoUsuario;
                        localStorage.setItem('usuarios_cadastrados', JSON.stringify(usuarios));
                        
                        console.log('Novo usu√°rio criado:', novoUsuario);
                        return { sucesso: true, usuario: novoUsuario, novo: true };
                    }
                } catch (error) {
                    console.error('Erro ao verificar usu√°rio:', error);
                    return { sucesso: false, mensagem: 'Erro interno. Tente novamente.' };
                }
            }

            static listarUsuarios() {
                try {
                    const usuarios = JSON.parse(localStorage.getItem('usuarios_cadastrados') || '{}');
                    return Object.values(usuarios);
                } catch (error) {
                    console.error('Erro ao listar usu√°rios:', error);
                    return [];
                }
            }

            static exportarDados(usuario) {
                try {
                    const compras = this.carregarDados(usuario, 'compras') || [];
                    const cartoes = this.carregarDados(usuario, 'cartoes') || [];
                    
                    const dadosExportacao = {
                        usuario: usuario,
                        dataExportacao: new Date().toISOString(),
                        versao: '1.0',
                        dados: {
                            compras,
                            cartoes
                        }
                    };
                    
                    return dadosExportacao;
                } catch (error) {
                    console.error('Erro ao exportar dados:', error);
                    return null;
                }
            }

            static importarDados(usuario, dadosImportados) {
                try {
                    if (dadosImportados.dados) {
                        if (dadosImportados.dados.compras) {
                            this.salvarDados(usuario, 'compras', dadosImportados.dados.compras);
                        }
                        if (dadosImportados.dados.cartoes) {
                            this.salvarDados(usuario, 'cartoes', dadosImportados.dados.cartoes);
                        }
                        return true;
                    }
                    return false;
                } catch (error) {
                    console.error('Erro ao importar dados:', error);
                    return false;
                }
            }

            static obterEstatisticasArmazenamento() {
                try {
                    let totalSize = 0;
                    let itemCount = 0;
                    
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key) && key.startsWith('gastos_')) {
                            const itemSize = localStorage.getItem(key).length;
                            totalSize += itemSize;
                            itemCount++;
                        }
                    }
                    
                    return {
                        totalSize: Math.round(totalSize / 1024), // KB
                        itemCount,
                        espacoDisponivel: this.obterEspacoDisponivel()
                    };
                } catch (error) {
                    console.error('Erro ao obter estat√≠sticas:', error);
                    return { totalSize: 0, itemCount: 0, espacoDisponivel: 'Desconhecido' };
                }
            }

            static obterEspacoDisponivel() {
                try {
                    // Tentar estimar o espa√ßo dispon√≠vel
                    let testKey = 'test_storage_space';
                    let testData = '0'.repeat(1024); // 1KB
                    let testSize = 0;
                    
                    while (testSize < 10240) { // Testar at√© 10MB
                        try {
                            localStorage.setItem(testKey, testData);
                            localStorage.removeItem(testKey);
                            testSize += 1024;
                            testData += '0'.repeat(1024);
                        } catch (e) {
                            localStorage.removeItem(testKey);
                            return Math.round(testSize / 1024) + 'KB+';
                        }
                    }
                    
                    localStorage.removeItem(testKey);
                    return '10MB+';
                } catch (error) {
                    return 'N√£o dispon√≠vel';
                }
            }
        }

        // Fun√ß√µes de autentica√ß√£o
        function fazerLogin() {
            const nome = document.getElementById('nomeUsuario').value.trim();
            const senha = document.getElementById('senhaUsuario').value;
            const statusDiv = document.getElementById('statusLogin');

            if (!nome) {
                mostrarStatus('statusLogin', 'Por favor, digite seu nome!', 'error');
                return;
            }

            const resultado = DataManager.verificarUsuario(nome, senha);
            
            if (resultado.sucesso) {
                usuarioAtual = resultado.usuario;
                
                // Atualizar √∫ltimo login
                if (!resultado.novo) {
                    try {
                        const usuarios = JSON.parse(localStorage.getItem('usuarios_cadastrados') || '{}');
                        const usuarioKey = nome.toLowerCase().replace(/\s+/g, '_');
                        usuarios[usuarioKey].ultimoLogin = new Date().toISOString();
                        localStorage.setItem('usuarios_cadastrados', JSON.stringify(usuarios));
                    } catch (error) {
                        console.error('Erro ao atualizar √∫ltimo login:', error);
                    }
                }
                
                document.getElementById('nomeUsuarioLogado').textContent = usuarioAtual.nome;
                
                // Carregar dados do usu√°rio
                carregarDadosUsuario();
                
                // Mostrar aplica√ß√£o principal
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('mainApp').style.display = 'block';
                
                const mensagem = resultado.novo ? 
                    'Bem-vindo! Sua conta foi criada com sucesso! Os dados ser√£o salvos localmente no seu navegador.' : 
                    'Login realizado com sucesso!';
                setTimeout(() => mostrarStatus('statusCompra', mensagem, 'success'), 500);
                
            } else {
                mostrarStatus('statusLogin', resultado.mensagem, 'error');
            }
        }

        function fazerLogout() {
            if (confirm('Tem certeza que deseja sair? Seus dados ficar√£o salvos localmente.')) {
                // Salvar √∫ltimo usu√°rio para facilitar pr√≥ximo login
                try {
                    localStorage.setItem('ultimo_usuario_logado', usuarioAtual.nome);
                } catch (error) {
                    console.error('Erro ao salvar √∫ltimo usu√°rio:', error);
                }
                
                usuarioAtual = null;
                compras = [];
                cartoes = [];
                
                // Limpar formul√°rios
                document.getElementById('nomeUsuario').value = '';
                document.getElementById('senhaUsuario').value = '';
                
                // Mostrar tela de login
                document.getElementById('mainApp').style.display = 'none';
                document.getElementById('loginScreen').style.display = 'block';
            }
        }

        function carregarDadosUsuario() {
            if (!usuarioAtual) return;
            
            // Carregar compras
            const comprasCarregadas = DataManager.carregarDados(usuarioAtual.nome, 'compras');
            compras = comprasCarregadas || [];
            
            // Carregar cart√µes (ou usar padr√£o para novos usu√°rios)
            const cartoesCarregados = DataManager.carregarDados(usuarioAtual.nome, 'cartoes');
            cartoes = cartoesCarregados || [
                { id: 1, nome: "Nubank", fechamento: 1, vencimento: 10, limite: 0, observacoes: "Cart√£o padr√£o" },
                { id: 2, nome: "Inter", fechamento: 15, vencimento: 25, limite: 0, observacoes: "Cart√£o padr√£o" },
                { id: 3, nome: "C6 Bank", fechamento: 5, vencimento: 15, limite: 0, observacoes: "Cart√£o padr√£o" }
            ];
            
            // Salvar cart√µes padr√£o se for novo usu√°rio
            if (!cartoesCarregados) {
                DataManager.salvarDados(usuarioAtual.nome, 'cartoes', cartoes);
            }
            
            console.log(`Dados carregados para ${usuarioAtual.nome}:`, {
                compras: compras.length,
                cartoes: cartoes.length
            });
            
            // Atualizar interface
            atualizarInterface();
        }

        function salvarDadosUsuario() {
            if (usuarioAtual) {
                const sucessoCompras = DataManager.salvarDados(usuarioAtual.nome, 'compras', compras);
                const sucessoCartoes = DataManager.salvarDados(usuarioAtual.nome, 'cartoes', cartoes);
                
                if (!sucessoCompras || !sucessoCartoes) {
                    console.warn('Erro ao salvar alguns dados do usu√°rio');
                }
                
                return sucessoCompras && sucessoCartoes;
            }
            return false;
        }

        function mostrarStatus(elementId, mensagem, tipo) {
            const element = document.getElementById(elementId);
            element.innerHTML = `<div class="status-message ${tipo}">${mensagem}</div>`;
            setTimeout(() => {
                element.innerHTML = '';
            }, tipo === 'error' ? 5000 : 3000); // Erros ficam mais tempo na tela
        }

        function atualizarInterface() {
            document.getElementById('dataCompra').value = new Date().toISOString().split('T')[0];
            
            // Definir data padr√£o da primeira parcela para financiamentos (pr√≥ximo m√™s)
            const proximoMes = new Date();
            proximoMes.setMonth(proximoMes.getMonth() + 1);
            document.getElementById('primeiraParcela').value = proximoMes.toISOString().split('T')[0];
            
            preencherMeses();
            atualizarFiltroCartoes();
            carregarCartoes();
            atualizarTabelaCartoes();
            atualizarTabelaCompras();
            carregarOpcoesParcelas('normal');
            
            // Configurar filtros de relat√≥rio
            configurarFiltrosRelatorio();
        }

        // Inicializa√ß√£o da p√°gina
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Sistema de Controle de Gastos iniciado');
            console.log('LocalStorage dispon√≠vel:', typeof(Storage) !== "undefined");
            
            // Verificar se h√° usu√°rio logado recentemente
            try {
                const ultimoUsuario = localStorage.getItem('ultimo_usuario_logado');
                if (ultimoUsuario) {
                    document.getElementById('nomeUsuario').value = ultimoUsuario;
                    console.log('√öltimo usu√°rio carregado:', ultimoUsuario);
                }
            } catch (error) {
                console.error('Erro ao carregar √∫ltimo usu√°rio:', error);
            }
            
            // Mostrar estat√≠sticas de armazenamento no console
            const stats = DataManager.obterEstatisticasArmazenamento();
            console.log('Estat√≠sticas de armazenamento:', stats);
        });

        function carregarOpcoesParcelas(tipoCompra) {
            const selectParcelas = document.getElementById('parcelas');
            selectParcelas.innerHTML = '';

            if (tipoCompra === 'normal') {
                // Op√ß√µes para cart√£o de cr√©dito (at√© 24x)
                const opcoes = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 15, 18, 24];
                opcoes.forEach(parcela => {
                    const option = document.createElement('option');
                    option.value = parcela;
                    option.textContent = parcela === 1 ? '1x (√Ä vista)' : `${parcela}x`;
                    selectParcelas.appendChild(option);
                });
            } else if (tipoCompra === 'financiamento') {
                // Op√ß√µes para financiamento (at√© 96x)
                const opcoes = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 15, 18, 24, 30, 36, 48, 60, 72, 84, 96];
                opcoes.forEach(parcela => {
                    const option = document.createElement('option');
                    option.value = parcela;
                    option.textContent = parcela === 1 ? '1x (√Ä vista)' : `${parcela}x`;
                    selectParcelas.appendChild(option);
                });
            }
        }

        function switchTab(tabName) {
            // Ocultar todas as abas
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            document.getElementById(tabName).classList.add('active');
            
            // Ativar bot√£o correspondente
            event.target.classList.add('active');
            
            // Atualizar visualiza√ß√£o se estiver na aba de apresenta√ß√£o
            if (tabName === 'apresentacao') {
                atualizarVisualizacao();
            }
            
            // Gerar relat√≥rio se estiver na aba de relat√≥rios
            if (tabName === 'relatorios') {
                gerarRelatorio();
            }
        }

        function toggleFinanciamento() {
            const tipoCompra = document.getElementById('tipoCompra').value;
            const secaoFinanciamento = document.getElementById('secaoFinanciamento');
            const categoria = document.getElementById('categoria');
            const grupoCartao = document.getElementById('grupoCartao');
            const cartaoSelect = document.getElementById('cartao');
            const labelDescricao = document.getElementById('labelDescricao');
            const labelValorTotal = document.getElementById('labelValorTotal');
            
            if (tipoCompra === 'financiamento') {
                secaoFinanciamento.style.display = 'block';
                grupoCartao.style.display = 'none';
                categoria.value = 'Financiamento';
                cartaoSelect.removeAttribute('required');
                labelDescricao.textContent = 'Descri√ß√£o do Financiamento';
                labelValorTotal.textContent = 'Valor Total do Financiamento (R$)';
                
                // Carregar op√ß√µes de parcelas para financiamento
                carregarOpcoesParcelas('financiamento');
                
                // Limpar sele√ß√£o do cart√£o
                cartaoSelect.value = '';
                
                // Definir data padr√£o para primeira parcela
                const proximoMes = new Date();
                proximoMes.setMonth(proximoMes.getMonth() + 1);
                document.getElementById('primeiraParcela').value = proximoMes.toISOString().split('T')[0];
            } else {
                secaoFinanciamento.style.display = 'none';
                grupoCartao.style.display = 'block';
                cartaoSelect.setAttribute('required', 'required');
                labelDescricao.textContent = 'Descri√ß√£o da Compra';
                labelValorTotal.textContent = 'Valor Total (R$)';
                
                // Carregar op√ß√µes de parcelas para cart√£o
                carregarOpcoesParcelas('normal');
                
                if (categoria.value === 'Financiamento') {
                    categoria.value = '';
                }
            }
        }

        function adicionarCartao() {
            const nome = document.getElementById('nomeCartao').value.trim();
            const fechamento = parseInt(document.getElementById('diaFechamento').value);
            const vencimento = parseInt(document.getElementById('diaVencimento').value);
            const limite = parseFloat(document.getElementById('limiteCartao').value) || 0;
            const observacoes = document.getElementById('observacoesCartao').value.trim();

            if (!nome || !fechamento || !vencimento) {
                mostrarStatus('statusCartao', 'Por favor, preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            // Verificar se j√° existe cart√£o com o mesmo nome
            const cartaoExistente = cartoes.find(c => c.nome.toLowerCase() === nome.toLowerCase());
            if (cartaoExistente) {
                mostrarStatus('statusCartao', 'J√° existe um cart√£o com este nome!', 'error');
                return;
            }

            const cartao = {
                id: Date.now(),
                nome,
                fechamento,
                vencimento,
                limite,
                observacoes,
                dataCriacao: new Date().toISOString()
            };

            cartoes.push(cartao);
            
            if (salvarDadosUsuario()) {
                atualizarTabelaCartoes();
                carregarCartoes();
                limparFormularioCartao();
                configurarFiltrosRelatorio();
                mostrarStatus('statusCartao', 'Cart√£o adicionado com sucesso!', 'success');
                console.log('Cart√£o adicionado:', cartao);
            } else {
                // Remover da lista se n√£o conseguiu salvar
                cartoes.pop();
                mostrarStatus('statusCartao', 'Erro ao salvar o cart√£o!', 'error');
            }
        }

        function excluirCartao(id) {
            const cartao = cartoes.find(c => c.id === id);
            if (!cartao) {
                mostrarStatus('statusCartao', 'Cart√£o n√£o encontrado!', 'error');
                return;
            }

            // Verificar se h√° compras vinculadas a este cart√£o
            const comprasVinculadas = compras.filter(c => c.cartao === cartao.nome);
            
            let mensagem = 'Tem certeza que deseja excluir este cart√£o?';
            if (comprasVinculadas.length > 0) {
                mensagem += `\n\nAten√ß√£o: Existem ${comprasVinculadas.length} compra(s) vinculada(s) a este cart√£o.`;
            }

            if (confirm(mensagem)) {
                cartoes = cartoes.filter(c => c.id !== id);
                
                if (salvarDadosUsuario()) {
                    atualizarTabelaCartoes();
                    carregarCartoes();
                    configurarFiltrosRelatorio();
                    mostrarStatus('statusCartao', 'Cart√£o exclu√≠do com sucesso!', 'success');
                    console.log('Cart√£o exclu√≠do:', cartao);
                } else {
                    // Restaurar se n√£o conseguiu salvar
                    cartoes.push(cartao);
                    mostrarStatus('statusCartao', 'Erro ao salvar altera√ß√µes!', 'error');
                }
            }
        }

        function atualizarTabelaCartoes() {
            const tbody = document.getElementById('tabelaCartoes');
            tbody.innerHTML = '';

            if (cartoes.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; color: #6b7280; padding: 30px;">
                        Nenhum cart√£o cadastrado. Adicione seu primeiro cart√£o acima.
                    </td>
                `;
                return;
            }

            cartoes.forEach(cartao => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${cartao.nome}</td>
                    <td>Dia ${cartao.fechamento}</td>
                    <td>Dia ${cartao.vencimento}</td>
                    <td class="currency">${cartao.limite > 0 ? `R$ ${cartao.limite.toFixed(2).replace('.', ',')}` : 'N√£o informado'}</td>
                    <td>${cartao.observacoes || '-'}</td>
                    <td>
                        <button class="btn btn-danger" onclick="excluirCartao(${cartao.id})" title="Excluir cart√£o">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
            });
        }

        function carregarCartoes() {
            const selectCartao = document.getElementById('cartao');
            selectCartao.innerHTML = '<option value="">Selecione o cart√£o</option>';

            cartoes.forEach(cartao => {
                const option = document.createElement('option');
                option.value = cartao.nome;
                option.textContent = cartao.nome;
                selectCartao.appendChild(option);
            });
        }

        function limparFormularioCartao() {
            document.getElementById('nomeCartao').value = '';
            document.getElementById('diaFechamento').value = '';
            document.getElementById('diaVencimento').value = '';
            document.getElementById('limiteCartao').value = '';
            document.getElementById('observacoesCartao').value = '';
        }

        function adicionarCompra() {
            const tipoCompra = document.getElementById('tipoCompra').value;
            const cartao = tipoCompra === 'financiamento' ? 'Financiamento' : document.getElementById('cartao').value;
            const dataCompra = document.getElementById('dataCompra').value;
            const descricao = document.getElementById('descricao').value.trim();
            const categoria = document.getElementById('categoria').value;
            const valorTotal = parseFloat(document.getElementById('valorTotal').value);
            const parcelas = parseInt(document.getElementById('parcelas').value);
            const observacoes = document.getElementById('observacoes').value.trim();

            // Valida√ß√£o espec√≠fica por tipo
            if (tipoCompra === 'normal' && !cartao) {
                mostrarStatus('statusCompra', 'Por favor, selecione um cart√£o para compras normais!', 'error');
                return;
            }

            if (!dataCompra || !descricao || !valorTotal || !parcelas) {
                mostrarStatus('statusCompra', 'Por favor, preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }

            if (valorTotal <= 0) {
                mostrarStatus('statusCompra', 'O valor deve ser maior que zero!', 'error');
                return;
            }

            if (parcelas <= 0) {
                mostrarStatus('statusCompra', 'O n√∫mero de parcelas deve ser maior que zero!', 'error');
                return;
            }

            const compra = {
                id: Date.now(),
                cartao,
                dataCompra,
                descricao,
                categoria: categoria || 'Outros',
                valorTotal,
                parcelas,
                valorParcela: valorTotal / parcelas,
                observacoes,
                tipoCompra,
                dataCriacao: new Date().toISOString()
            };

            // Se for financiamento, adicionar dados espec√≠ficos
            if (tipoCompra === 'financiamento') {
                const primeiraParcela = document.getElementById('primeiraParcela').value;
                if (!primeiraParcela) {
                    mostrarStatus('statusCompra', 'Por favor, defina a data da primeira parcela para financiamentos!', 'error');
                    return;
                }
                compra.valorFinanciado = parseFloat(document.getElementById('valorFinanciado').value) || 0;
                compra.taxaJuros = parseFloat(document.getElementById('taxaJuros').value) || 0;
                compra.tipoFinanciamento = document.getElementById('tipoFinanciamento').value;
                compra.entrada = parseFloat(document.getElementById('entrada').value) || 0;
                compra.primeiraParcela = primeiraParcela;
            }

            compras.push(compra);
            
            if (salvarDadosUsuario()) {
                atualizarTabelaCompras();
                limparFormulario();
                atualizarFiltroCartoes();
                mostrarStatus('statusCompra', 'Compra adicionada com sucesso!', 'success');
                console.log('Compra adicionada:', compra);
                
                // Atualizar visualiza√ß√£o se estiver na aba ativa
                const abaAtiva = document.querySelector('.tab-content.active');
                if (abaAtiva && abaAtiva.id === 'apresentacao') {
                    atualizarVisualizacao();
                }
            } else {
                // Remover da lista se n√£o conseguiu salvar
                compras.pop();
                mostrarStatus('statusCompra', 'Erro ao salvar a compra!', 'error');
            }
        }

        function atualizarTabelaCompras() {
            const tbody = document.getElementById('tabelaCompras');
            tbody.innerHTML = '';

            if (compras.length === 0) {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td colspan="8" style="text-align: center; color: #6b7280; padding: 30px;">
                        Nenhuma compra cadastrada. Adicione sua primeira compra acima.
                    </td>
                `;
                return;
            }

            // Ordenar compras por data (mais recente primeiro)
            const comprasOrdenadas = [...compras].sort((a, b) => new Date(b.dataCompra) - new Date(a.dataCompra));

            comprasOrdenadas.forEach(compra => {
                const row = tbody.insertRow();
                const tipoIcon = compra.tipoCompra === 'financiamento' ? 'üí∞' : '';
                const categoriaDisplay = compra.categoria ? `${tipoIcon} ${compra.categoria}` : '-';
                
                row.innerHTML = `
                    <td>${new Date(compra.dataCompra + 'T00:00:00').toLocaleDateString('pt-BR')}</td>
                    <td>${compra.cartao}</td>
                    <td>${compra.descricao}${compra.tipoCompra === 'financiamento' ? ' (Financiamento)' : ''}
                        ${compra.observacoes ? `<br><small style="color: #6b7280;">${compra.observacoes}</small>` : ''}
                    </td>
                    <td>${categoriaDisplay}</td>
                    <td class="currency">R$ ${compra.valorTotal.toFixed(2).replace('.', ',')}</td>
                    <td>${compra.parcelas}x</td>
                    <td class="currency">R$ ${compra.valorParcela.toFixed(2).replace('.', ',')}</td>
                    <td>
                        <button class="btn btn-danger" onclick="excluirCompra(${compra.id})" title="Excluir compra">
                            üóëÔ∏è
                        </button>
                    </td>
                `;
            });
        }

        function excluirCompra(id) {
            const compra = compras.find(c => c.id === id);
            if (!compra) {
                mostrarStatus('statusCompra', 'Compra n√£o encontrada!', 'error');
                return;
            }

            if (confirm(`Tem certeza que deseja excluir a compra "${compra.descricao}"?`)) {
                compras = compras.filter(c => c.id !== id);
                
                if (salvarDadosUsuario()) {
                    atualizarTabelaCompras();
                    atualizarFiltroCartoes();
                    atualizarVisualizacao();
                    mostrarStatus('statusCompra', 'Compra exclu√≠da com sucesso!', 'success');
                    console.log('Compra exclu√≠da:', compra);
                } else {
                    // Restaurar se n√£o conseguiu salvar
                    compras.push(compra);
                    mostrarStatus('statusCompra', 'Erro ao salvar altera√ß√µes!', 'error');
                }
            }
        }

        function limparFormulario() {
            document.getElementById('tipoCompra').value = 'normal';
            document.getElementById('cartao').value = '';
            document.getElementById('descricao').value = '';
            document.getElementById('categoria').value = '';
            document.getElementById('valorTotal').value = '';
            document.getElementById('parcelas').value = '1';
            document.getElementById('observacoes').value = '';
            
            // Resetar interface
            document.getElementById('secaoFinanciamento').style.display = 'none';
            document.getElementById('grupoCartao').style.display = 'block';
            document.getElementById('cartao').setAttribute('required', 'required');
            document.getElementById('labelDescricao').textContent = 'Descri√ß√£o da Compra';
            document.getElementById('labelValorTotal').textContent = 'Valor Total (R$)';
            
            // Recarregar op√ß√µes de parcelas para compra normal
            carregarOpcoesParcelas('normal');
            
            // Limpar campos de financiamento
            document.getElementById('valorFinanciado').value = '';
            document.getElementById('taxaJuros').value = '';
            document.getElementById('tipoFinanciamento').value = '';
            document.getElementById('entrada').value = '';
            
            // Definir nova data padr√£o para primeira parcela
            const proximoMes = new Date();
            proximoMes.setMonth(proximoMes.getMonth() + 1);
            document.getElementById('primeiraParcela').value = proximoMes.toISOString().split('T')[0];
        }

        function preencherMeses() {
            const selectMes = document.getElementById('filtroMes');
            const valorAtual = selectMes.value; // Manter sele√ß√£o atual
            selectMes.innerHTML = '';
            
            // Coletar todos os meses que t√™m parcelas
            const mesesComParcelas = new Set();
            const dataAtual = new Date();
            const nomesMes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            
            compras.forEach(compra => {
                // Calcular primeira parcela baseada no fechamento do cart√£o ou data espec√≠fica
                const primeiraParcela = calcularPrimeiraParcela(compra.dataCompra, compra.cartao, compra.primeiraParcela);
                
                // Adicionar todos os meses das parcelas desta compra
                for (let parcela = 1; parcela <= compra.parcelas; parcela++) {
                    const dataParcela = new Date(primeiraParcela.getFullYear(), primeiraParcela.getMonth() + (parcela - 1), 1);
                    const mesAno = `${String(dataParcela.getMonth() + 1).padStart(2, '0')}/${dataParcela.getFullYear()}`;
                    mesesComParcelas.add(mesAno);
                }
            });
            
            // Converter para array e ordenar
            const mesesOrdenados = Array.from(mesesComParcelas).sort((a, b) => {
                const [mesA, anoA] = a.split('/').map(Number);
                const [mesB, anoB] = b.split('/').map(Number);
                if (anoA !== anoB) return anoA - anoB;
                return mesA - mesB;
            });
            
            // Se n√£o h√° compras, mostrar alguns meses padr√£o
            if (mesesOrdenados.length === 0) {
                for (let i = -2; i <= 12; i++) {
                    const data = new Date(dataAtual.getFullYear(), dataAtual.getMonth() + i, 1);
                    const mesAno = `${String(data.getMonth() + 1).padStart(2, '0')}/${data.getFullYear()}`;
                    mesesOrdenados.push(mesAno);
                }
                // Remover duplicatas e ordenar novamente
                const mesesUnicos = [...new Set(mesesOrdenados)].sort((a, b) => {
                    const [mesA, anoA] = a.split('/').map(Number);
                    const [mesB, anoB] = b.split('/').map(Number);
                    if (anoA !== anoB) return anoA - anoB;
                    return mesA - mesB;
                });
                mesesOrdenados.length = 0;
                mesesOrdenados.push(...mesesUnicos);
            }
            
            // Adicionar op√ß√µes ao select
            mesesOrdenados.forEach((mesAno, index) => {
                const [mes, ano] = mesAno.split('/').map(Number);
                const nomeCompleto = `${nomesMes[mes - 1]} ${ano}`;
                
                const option = document.createElement('option');
                option.value = mesAno;
                option.textContent = nomeCompleto;
                
                // Manter sele√ß√£o anterior ou selecionar o pr√≥ximo m√™s como padr√£o
                if (valorAtual && mesAno === valorAtual) {
                    option.selected = true;
                } else if (!valorAtual) {
                    const proximoMes = new Date(dataAtual.getFullYear(), dataAtual.getMonth() + 1, 1);
                    const proximoMesAno = `${String(proximoMes.getMonth() + 1).padStart(2, '0')}/${proximoMes.getFullYear()}`;
                    
                    if (mesAno === proximoMesAno || (index === 0 && !mesesOrdenados.includes(proximoMesAno))) {
                        option.selected = true;
                    }
                }
                
                selectMes.appendChild(option);
            });
        }

        function atualizarFiltroCartoes() {
            const selectCartao = document.getElementById('filtroCartao');
            const valorAtual = selectCartao.value; // Manter sele√ß√£o atual
            const cartoesUnicos = [...new Set(compras.map(compra => compra.cartao))];
            
            // Manter a op√ß√£o "Todos os cart√µes"
            selectCartao.innerHTML = '<option value="">Todos os cart√µes</option>';
            
            cartoesUnicos.forEach(cartao => {
                const option = document.createElement('option');
                option.value = cartao;
                option.textContent = cartao;
                
                // Manter sele√ß√£o anterior
                if (valorAtual && cartao === valorAtual) {
                    option.selected = true;
                }
                
                selectCartao.appendChild(option);
            });
            
            // Atualizar lista de meses tamb√©m, pois pode ter mudado
            preencherMeses();
        }

        // FUN√á√ÉO CORRIGIDA DO FECHAMENTO
        function calcularPrimeiraParcela(dataCompra, nomeCartao, primeiraParcela = null) {
            // Para financiamentos com data espec√≠fica, usar a data definida
            if (primeiraParcela) {
                const data = new Date(primeiraParcela + 'T00:00:00');
                return new Date(data.getFullYear(), data.getMonth(), 1);
            }

            // Para financiamentos sem data espec√≠fica, usar sempre o pr√≥ximo m√™s
            if (nomeCartao === 'Financiamento') {
                const data = new Date(dataCompra + 'T00:00:00');
                return new Date(data.getFullYear(), data.getMonth() + 1, 1);
            }

            const cartao = cartoes.find(c => c.nome === nomeCartao);
            if (!cartao) {
                // Fallback para fechamento no dia 1 se cart√£o n√£o encontrado
                const data = new Date(dataCompra + 'T00:00:00');
                return new Date(data.getFullYear(), data.getMonth() + 1, 1);
            }

            const data = new Date(dataCompra + 'T00:00:00');
            const anoCompra = data.getFullYear();
            const mesCompra = data.getMonth(); // 0-11
            const diaCompra = data.getDate(); // 1-31
            const diaFechamento = cartao.fechamento;
            
            // Se a data de fechamento j√° passou neste m√™s, considerar o fechamento do pr√≥ximo m√™s
            if (diaCompra > diaFechamento) {
                // Compra foi ap√≥s o fechamento, vai para a pr√≥xima fatura (m√™s + 1)
                return new Date(anoCompra, mesCompra + 1, 1);
            } else {
                // Compra foi antes/no dia do fechamento, vai para a fatura atual (mesmo m√™s)
                return new Date(anoCompra, mesCompra, 1);
            }
        }

        function atualizarVisualizacao() {
            const cartaoFiltro = document.getElementById('filtroCartao').value;
            const mesFiltro = document.getElementById('filtroMes').value;
            
            if (!mesFiltro) {
                document.getElementById('totalPagar').textContent = 'R$ 0,00';
                document.getElementById('periodoInfo').textContent = 'Selecione um per√≠odo para visualizar';
                document.getElementById('detalhesGastos').innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 20px;">üìä</div>
                        <p>Selecione um cart√£o e m√™s para ver os detalhes dos gastos</p>
                    </div>
                `;
                return;
            }

            const [mes, ano] = mesFiltro.split('/').map(Number);
            let total = 0;
            let detalhes = [];

            compras.forEach(compra => {
                // Verificar se o cart√£o corresponde ao filtro
                if (cartaoFiltro && compra.cartao !== cartaoFiltro) {
                    return;
                }

                // Calcular primeira parcela baseada no fechamento do cart√£o
                const primeiraParcela = calcularPrimeiraParcela(compra.dataCompra, compra.cartao, compra.primeiraParcela);
                
                // Verificar todas as parcelas da compra
                for (let parcela = 1; parcela <= compra.parcelas; parcela++) {
                    const dataParcela = new Date(primeiraParcela.getFullYear(), primeiraParcela.getMonth() + (parcela - 1), 1);
                    
                    if (dataParcela.getMonth() + 1 === mes && dataParcela.getFullYear() === ano) {
                        total += compra.valorParcela;
                        const tipoDisplay = compra.tipoCompra === 'financiamento' ? 'üí∞ ' : '';
                        detalhes.push({
                            descricao: `${tipoDisplay}${compra.descricao} (${parcela}¬™ de ${compra.parcelas} parcelas)`,
                            valor: compra.valorParcela,
                            cartao: compra.cartao,
                            categoria: compra.categoria
                        });
                    }
                }
            });

            // Atualizar interface
            document.getElementById('totalPagar').textContent = `R$ ${total.toFixed(2).replace('.', ',')}`;
            
            const nomesMes = ['Janeiro', 'Fevereiro', 'Mar√ßo', 'Abril', 'Maio', 'Junho', 
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
            const nomeCartao = cartaoFiltro || 'Todos os cart√µes';
            document.getElementById('periodoInfo').textContent = `${nomeCartao} - ${nomesMes[mes-1]} ${ano}`;

            // Mostrar detalhes
            const detalhesContainer = document.getElementById('detalhesGastos');
            if (detalhes.length === 0) {
                detalhesContainer.innerHTML = `
                    <div class="empty-state">
                        <div style="font-size: 48px; margin-bottom: 20px;">ü§∑‚Äç‚ôÇÔ∏è</div>
                        <p>Nenhum gasto encontrado para este per√≠odo</p>
                    </div>
                `;
            } else {
                // Ordenar detalhes por valor (maior primeiro)
                detalhes.sort((a, b) => b.valor - a.valor);
                
                detalhesContainer.innerHTML = detalhes.map(detalhe => `
                    <div class="detail-item">
                        <div class="detail-description">
                            ${detalhe.descricao}
                            ${cartaoFiltro ? '' : `<br><small style="color: #6b7280;">${detalhe.cartao}</small>`}
                            ${detalhe.categoria ? `<br><small style="color: #059669;">${detalhe.categoria}</small>` : ''}
                        </div>
                        <div class="detail-value">R$ ${detalhe.valor.toFixed(2).replace('.', ',')}</div>
                    </div>
                `).join('');
            }
        }

        // FUN√á√ïES DE RELAT√ìRIO
        function configurarFiltrosRelatorio() {
            // Configurar filtro de cart√£o
            const selectCartao = document.getElementById('relatorioCartao');
            const cartoesUnicos = [...new Set(compras.map(compra => compra.cartao))];
            
            selectCartao.innerHTML = '<option value="">Todos os cart√µes</option>';
            cartoesUnicos.forEach(cartao => {
                const option = document.createElement('option');
                option.value = cartao;
                option.textContent = cartao;
                selectCartao.appendChild(option);
            });

            // Configurar datas padr√£o (√∫ltimos 3 meses)
            const hoje = new Date();
            const dataFim = new Date(hoje.getFullYear(), hoje.getMonth(), hoje.getDate());
            const dataInicio = new Date(hoje.getFullYear(), hoje.getMonth() - 2, 1);
            
            document.getElementById('relatorioDataInicio').value = dataInicio.toISOString().split('T')[0];
            document.getElementById('relatorioDataFim').value = dataFim.toISOString().split('T')[0];
        }

        function gerarRelatorio() {
            const dataInicio = document.getElementById('relatorioDataInicio').value;
            const dataFim = document.getElementById('relatorioDataFim').value;
            const cartaoFiltro = document.getElementById('relatorioCartao').value;
            const categoriaFiltro = document.getElementById('relatorioCategoria').value;

            if (!dataInicio || !dataFim) {
                return;
            }

            if (new Date(dataInicio) > new Date(dataFim)) {
                mostrarStatus('statusCompra', 'A data de in√≠cio deve ser anterior √† data de fim!', 'error');
                return;
            }

            // Filtrar compras no per√≠odo
            const comprasFiltradas = compras.filter(compra => {
                const dataCompra = new Date(compra.dataCompra + 'T00:00:00');
                const inicio = new Date(dataInicio + 'T00:00:00');
                const fim = new Date(dataFim + 'T23:59:59');
                
                const dentroData = dataCompra >= inicio && dataCompra <= fim;
                const dentroCartao = !cartaoFiltro || compra.cartao === cartaoFiltro;
                const dentroCategoria = !categoriaFiltro || compra.categoria === categoriaFiltro;
                
                return dentroData && dentroCartao && dentroCategoria;
            });

            // Gerar relat√≥rio por cart√£o
            gerarRelatorioCartoes(comprasFiltradas);
            
            // Gerar relat√≥rio por categoria
            gerarRelatorioCategorias(comprasFiltradas);
            
            // Gerar relat√≥rio mensal
            gerarRelatorioMensal(comprasFiltradas);
        }

        function gerarRelatorioCartoes(comprasFiltradas) {
            const relatorioCartoes = {};
            
            comprasFiltradas.forEach(compra => {
                if (!relatorioCartoes[compra.cartao]) {
                    relatorioCartoes[compra.cartao] = {
                        total: 0,
                        quantidade: 0
                    };
                }
                relatorioCartoes[compra.cartao].total += compra.valorTotal;
                relatorioCartoes[compra.cartao].quantidade += 1;
            });

            const container = document.getElementById('relatorioCartoes');
            
            if (Object.keys(relatorioCartoes).length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nenhum gasto encontrado no per√≠odo selecionado</p></div>';
                return;
            }

            // Ordenar por valor total
            const cartoesOrdenados = Object.entries(relatorioCartoes)
                .sort(([,a], [,b]) => b.total - a.total);

            const totalGeral = cartoesOrdenados.reduce((sum, [, dados]) => sum + dados.total, 0);

            let html = cartoesOrdenados.map(([cartao, dados]) => {
                const percentual = totalGeral > 0 ? ((dados.total / totalGeral) * 100).toFixed(1) : 0;
                return `
                    <div class="report-item">
                        <div class="report-label">
                            ${cartao} (${dados.quantidade} compra${dados.quantidade > 1 ? 's' : ''})
                            <br><small style="color: #6b7280;">${percentual}% do total</small>
                        </div>
                        <div class="report-value">R$ ${dados.total.toFixed(2).replace('.', ',')}</div>
                    </div>
                `;
            }).join('');

            // Adicionar total geral
            html += `
                <div class="report-item" style="border-top: 2px solid #3b82f6; margin-top: 10px; padding-top: 15px;">
                    <div class="report-label" style="font-weight: bold;">Total Geral</div>
                    <div class="report-value" style="color: #3b82f6; font-size: 20px;">R$ ${totalGeral.toFixed(2).replace('.', ',')}</div>
                </div>
            `;

            container.innerHTML = html;
        }

        function gerarRelatorioCategorias(comprasFiltradas) {
            const relatorioCategorias = {};
            
            comprasFiltradas.forEach(compra => {
                const categoria = compra.categoria || 'Sem Categoria';
                if (!relatorioCategorias[categoria]) {
                    relatorioCategorias[categoria] = {
                        total: 0,
                        quantidade: 0
                    };
                }
                relatorioCategorias[categoria].total += compra.valorTotal;
                relatorioCategorias[categoria].quantidade += 1;
            });

            const container = document.getElementById('relatorioCategorias');
            
            if (Object.keys(relatorioCategorias).length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nenhum gasto encontrado no per√≠odo selecionado</p></div>';
                return;
            }

            // Ordenar por valor total
            const categoriasOrdenadas = Object.entries(relatorioCategorias)
                .sort(([,a], [,b]) => b.total - a.total);

            const totalGeral = categoriasOrdenadas.reduce((sum, [, dados]) => sum + dados.total, 0);

            let html = categoriasOrdenadas.map(([categoria, dados]) => {
                const percentual = totalGeral > 0 ? ((dados.total / totalGeral) * 100).toFixed(1) : 0;
                return `
                    <div class="report-item">
                        <div class="report-label">
                            ${categoria} (${dados.quantidade} compra${dados.quantidade > 1 ? 's' : ''})
                            <br><small style="color: #6b7280;">${percentual}% do total</small>
                        </div>
                        <div class="report-value">R$ ${dados.total.toFixed(2).replace('.', ',')}</div>
                    </div>
                `;
            }).join('');

            // Adicionar total geral
            html += `
                <div class="report-item" style="border-top: 2px solid #3b82f6; margin-top: 10px; padding-top: 15px;">
                    <div class="report-label" style="font-weight: bold;">Total Geral</div>
                    <div class="report-value" style="color: #3b82f6; font-size: 20px;">R$ ${totalGeral.toFixed(2).replace('.', ',')}</div>
                </div>
            `;

            container.innerHTML = html;
        }

        function gerarRelatorioMensal(comprasFiltradas) {
            const relatorioMensal = {};
            const nomesMes = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 
                           'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            
            comprasFiltradas.forEach(compra => {
                const data = new Date(compra.dataCompra + 'T00:00:00');
                const mesAno = `${nomesMes[data.getMonth()]}/${data.getFullYear()}`;
                
                if (!relatorioMensal[mesAno]) {
                    relatorioMensal[mesAno] = {
                        total: 0,
                        quantidade: 0,
                        ordenacao: data.getFullYear() * 12 + data.getMonth() // Para ordena√ß√£o correta
                    };
                }
                relatorioMensal[mesAno].total += compra.valorTotal;
                relatorioMensal[mesAno].quantidade += 1;
            });

            const container = document.getElementById('relatorioMensal');
            
            if (Object.keys(relatorioMensal).length === 0) {
                container.innerHTML = '<div class="empty-state"><p>Nenhum gasto encontrado no per√≠odo selecionado</p></div>';
                return;
            }

            // Ordenar por m√™s/ano
            const mesesOrdenados = Object.entries(relatorioMensal)
                .sort(([,a], [,b]) => a.ordenacao - b.ordenacao);

            const totalGeral = mesesOrdenados.reduce((sum, [, dados]) => sum + dados.total, 0);
            const mediaGeral = totalGeral / mesesOrdenados.length;

            let html = mesesOrdenados.map(([mesAno, dados]) => {
                const percentual = totalGeral > 0 ? ((dados.total / totalGeral) * 100).toFixed(1) : 0;
                const comparacaoMedia = dados.total > mediaGeral ? '‚Üë' : dados.total < mediaGeral ? '‚Üì' : '‚Üí';
                const corComparacao = dados.total > mediaGeral ? '#ef4444' : dados.total < mediaGeral ? '#059669' : '#6b7280';
                
                return `
                    <div class="report-item">
                        <div class="report-label">
                            ${mesAno} (${dados.quantidade} compra${dados.quantidade > 1 ? 's' : ''})
                            <br><small style="color: #6b7280;">
                                ${percentual}% do total 
                                <span style="color: ${corComparacao};">${comparacaoMedia}</span>
                            </small>
                        </div>
                        <div class="report-value">R$ ${dados.total.toFixed(2).replace('.', ',')}</div>
                    </div>
                `;
            }).join('');

            // Adicionar estat√≠sticas gerais
            html += `
                <div class="report-item" style="border-top: 2px solid #3b82f6; margin-top: 10px; padding-top: 15px;">
                    <div class="report-label" style="font-weight: bold;">
                        Total Geral
                        <br><small style="color: #6b7280;">M√©dia mensal: R$ ${mediaGeral.toFixed(2).replace('.', ',')}</small>
                    </div>
                    <div class="report-value" style="color: #3b82f6; font-size: 20px;">R$ ${totalGeral.toFixed(2).replace('.', ',')}</div>
                </div>
            `;

            container.innerHTML = html;
        }

        // Fun√ß√µes utilit√°rias para exportar/importar dados
        function exportarDadosUsuario() {
            if (!usuarioAtual) {
                mostrarStatus('statusCompra', 'Nenhum usu√°rio logado!', 'error');
                return;
            }

            const dados = DataManager.exportarDados(usuarioAtual.nome);
            if (!dados) {
                mostrarStatus('statusCompra', 'Erro ao exportar dados!', 'error');
                return;
            }

            const dataStr = JSON.stringify(dados, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `gastos_${usuarioAtual.nome.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            URL.revokeObjectURL(url);
            mostrarStatus('statusCompra', 'Dados exportados com sucesso!', 'success');
        }

        function importarDadosUsuario(event) {
            if (!usuarioAtual) {
                mostrarStatus('statusCompra', 'Nenhum usu√°rio logado!', 'error');
                return;
            }

            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const dadosImportados = JSON.parse(e.target.result);
                    
                    if (DataManager.importarDados(usuarioAtual.nome, dadosImportados)) {
                        carregarDadosUsuario();
                        mostrarStatus('statusCompra', 'Dados importados com sucesso!', 'success');
                    } else {
                        mostrarStatus('statusCompra', 'Erro ao importar dados! Verifique o formato do arquivo.', 'error');
                    }
                } catch (error) {
                    console.error('Erro ao importar:', error);
                    mostrarStatus('statusCompra', 'Arquivo inv√°lido!', 'error');
                }
            };
            
            reader.readAsText(file);
            event.target.value = ''; // Limpar input
        }

        // Event listeners para atalhos de teclado
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S para exportar dados
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                if (usuarioAtual) {
                    exportarDadosUsuario();
                }
            }
            
            // Enter na tela de login
            if (document.getElementById('loginScreen').style.display !== 'none') {
                if (e.key === 'Enter') {
                    fazerLogin();
                }
            }
        });

        // Backup autom√°tico (opcional)
        function backupAutomatico() {
            if (usuarioAtual && compras.length > 0) {
                try {
                    const dados = DataManager.exportarDados(usuarioAtual.nome);
                    localStorage.setItem(`backup_${usuarioAtual.nome}_${new Date().toDateString()}`, JSON.stringify(dados));
                    
                    // Manter apenas os √∫ltimos 7 backups
                    const chaves = Object.keys(localStorage).filter(k => k.startsWith(`backup_${usuarioAtual.nome}_`));
                    if (chaves.length > 7) {
                        chaves.sort().slice(0, -7).forEach(chave => localStorage.removeItem(chave));
                    }
                } catch (error) {
                    console.warn('Erro no backup autom√°tico:', error);
                }
            }
        }

        // Executar backup autom√°tico a cada 30 minutos
        setInterval(backupAutomatico, 30 * 60 * 1000);

        // Salvar dados automaticamente antes de fechar a p√°gina
        window.addEventListener('beforeunload', function(e) {
            if (usuarioAtual) {
                salvarDadosUsuario();
                try {
                    localStorage.setItem('ultimo_usuario_logado', usuarioAtual.nome);
                } catch (error) {
                    console.error('Erro ao salvar √∫ltimo usu√°rio:', error);
                }
            }
        });

        // Verificar espa√ßo de armazenamento periodicamente
        function verificarEspacoArmazenamento() {
            const stats = DataManager.obterEstatisticasArmazenamento();
            
            // Alerta se estiver usando muito espa√ßo (> 8MB estimado)
            if (stats.totalSize > 8192) { // 8MB
                console.warn('Armazenamento local est√° ficando cheio. Considere exportar os dados.');
                if (usuarioAtual) {
                    mostrarStatus('statusCompra', 'Aten√ß√£o: Espa√ßo de armazenamento local baixo. Considere exportar seus dados.', 'error');
                }
            }
        }

        // Verificar espa√ßo a cada 5 minutos
        setInterval(verificarEspacoArmazenamento, 5 * 60 * 1000);

        // Fun√ß√£o para limpar dados antigos (pode ser chamada manualmente)
        function limparBackupsAntigos() {
            try {
                const hoje = new Date();
                const seteDiasAtras = new Date(hoje.getTime() - 7 * 24 * 60 * 60 * 1000);
                
                Object.keys(localStorage).forEach(chave => {
                    if (chave.startsWith('backup_')) {
                        try {
                            const partes = chave.split('_');
                            if (partes.length >= 3) {
                                const dataBackup = new Date(partes.slice(2).join('_'));
                                if (dataBackup < seteDiasAtras) {
                                    localStorage.removeItem(chave);
                                }
                            }
                        } catch (error) {
                            console.warn('Erro ao processar backup:', chave, error);
                        }
                    }
                });
                
                console.log('Limpeza de backups antigos conclu√≠da');
            } catch (error) {
                console.error('Erro na limpeza de backups:', error);
            }
        }

        // Executar limpeza de backups na inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(limparBackupsAntigos, 2000);
        });

        console.log('Sistema de Controle de Gastos carregado com localStorage');
    </script>
</body>
</html>
